
#include "mcc_generated_files/system.h"
#include "mcc_generated_files/mcc.h"

#include "dualmotor.h"
#include "display.h"
#include <libpic30.h>



 uint8_t sh1106_init[] = {           
    0x80, 0xA1,     //segment remap left
    0x80, 0xC8,     //set scan direction
    0x00, 0x50      //set scan display line
};
 uint8_t sh1106_on[] = {
    0x00, 0xAF      // ??turn display on
};
 uint8_t sh1106_blankpix[] = {
     0xc0, 00
 };
 
 const uint8_t colpos[] = {
     0x04, 0x0E, 0x18, 0x22, 0x2C, 0x36, 0x40, 0x4A, 0x54, 0x5E, 0x68, 0x72
 };
 
 const uint8_t linepos[] = {
     0x00, 0x02, 0x04, 0x06     
 }; 
 
 const uint8_t chset1[] = {
     0x00, 0x08, 0x04, 0x02, 0x02, 0xFE, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x40, 0x40, 0x40, 0x40, 0x7F, 0x40, 0x40, 0x40, 0x00,
     0x00, 0x10, 0x08, 0x04, 0x02, 0x02, 0x04, 0x88, 0x70, 0x00,
     0x00, 0x60, 0x50, 0x48, 0x44, 0x42, 0x41, 0x40, 0x40, 0x00,
    
 };
 
 const uint8_t chset2[] = {
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //chr 0
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x08, 0x04, 0x02, 0x02, 0xFE, 0x00, 0x00, 0x00, 0x00, //chr 1
     0x00, 0x40, 0x40, 0x40, 0x40, 0x7F, 0x40, 0x40, 0x40, 0x00,
     0x00, 0x10, 0x08, 0x04, 0x02, 0x02, 0x04, 0x88, 0x70, 0x00, //chr 2
     0x00, 0x60, 0x50, 0x48, 0x44, 0x42, 0x41, 0x40, 0x40, 0x00,
     0x00, 0x04, 0x82, 0x82, 0x82, 0x82, 0x82, 0x82, 0xFE, 0x00, //chr 3
     0x00, 0x20, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x3F, 0x00,
     0x00, 0xFE, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFE, 0x00, //chr 4
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x00,
     0x00, 0x7E, 0x42, 0x42, 0x42, 0x82, 0x02, 0x02, 0x02, 0x00, //chr 5
     0x00, 0x40, 0x40, 0x40, 0x40, 0x40, 0x21, 0x12, 0x0C, 0x00,
     0x00, 0x80, 0x60, 0x10, 0x88, 0x84, 0x02, 0x02, 0x00, 0x00, //chr 6
     0x00, 0x0E, 0x12, 0x21, 0x40, 0x40, 0x21, 0x12, 0x0C, 0x00,
     0x00, 0x02, 0x02, 0x02, 0x02, 0x82, 0x62, 0x1A, 0x06, 0x00, //chr 7
     0x00, 0x00, 0x60, 0x18, 0x06, 0x01, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x30, 0x48, 0x84, 0x82, 0x82, 0x84, 0x48, 0x30, 0x00, //chr 8
     0x00, 0x0C, 0x12, 0x21, 0x41, 0x41, 0x21, 0x12, 0x0C, 0x00,
     0x00, 0x30, 0x48, 0x84, 0x02, 0x02, 0x84, 0x48, 0xF0, 0x00, //chr 9
     0x00, 0x00, 0x40, 0x20, 0x11, 0x09, 0x04, 0x02, 0x01, 0x00,
     0x00, 0xF0, 0x08, 0x04, 0x02, 0x02, 0x04, 0x08, 0xF0, 0x00, //chr 10
     0x00, 0x0F, 0x10, 0x20, 0x40, 0x40, 0x20, 0x10, 0x0F, 0x00,
     0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, //chr 11
     0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00
 };

 

 
 
 
 
 void sh1106_Init(void){    
    
    while(i2c_Ready() == I2C_STATUS_FULL);
    i2c_Write(sh1106_init, sizeof(sh1106_init));      

    __delay_ms(150);
    sh1106_On();
    __delay_ms(150);
    sh1106_ClearAll(); 
   
       
    __delay_ms(150);     
 }
 
 void sh1106_On(void){
     while(i2c_Ready() == I2C_STATUS_FULL);
     i2c_Write(sh1106_on, sizeof(sh1106_on));    
 }
 
 void sh1106_ClearPage(uint8_t page){
     
    static uint8_t ddata[180];
    int i = 0;     
    page = page & 0x07;      
    ddata[i] = 0x80;
    i++;
    ddata[i] = 0xB0 + page;  //select page 0 - 7
    i++;
    ddata[i] = 0x80;
    i++;
    ddata[i] = 0x00;
    i++;
    ddata[i] = 0x80;
    i++;
    ddata[i] = 0x10;        // column 0
    i++;    
    ddata[i] = 0x40;
    i++; 
    //139 
   for(;i < 139;){
       ddata[i] = 0x00;
       i++;
   } 
    while(i2c_Ready() != I2C_STATUS_IDLE);
    i2c_Write(ddata, i);
   
 }
 
 void sh1106_ClearAll(void){
     
    uint8_t page = 0;
    for(;page < 8; page++){
       sh1106_ClearPage(page);
    }  
 }
 
 void sh1106_Char(uint8_t col, uint8_t line, int chr) {
    static uint8_t ddata[54];
    int charindx = chr * 20;
    uint8_t page = linepos[line];
    uint8_t collow = colpos[col] & 0x0F;
    int8_t colhigh = (colpos[col] >> 4) | 0x10;
    int i = 0;

    ddata[i] = 0x80;
    i++;
    ddata[i] = 0xB0 + page; //select page 0 - 7
    i++;
    ddata[i] = 0x80;
    i++;
    ddata[i] = collow;
    i++;
    ddata[i] = 0x80;
    i++;
    ddata[i] = colhigh;
    i++;
    int j;
    for (j = 0; j < 10; j++) {
        ddata[i] = 0xC0;
        i++;
        ddata[i] = chset2[charindx];
        i++;
        charindx++;
    }

    ddata[i] = 0x80;
    i++;
    ddata[i] = 0xB0 + page + 1; //select page 0 - 7
    i++;
    ddata[i] = 0x80;
    i++;
    ddata[i] = collow;
    i++;
    ddata[i] = 0x80;
    i++;
    ddata[i] = colhigh;
    i++;
    for (j = 0; j < 9; j++) {
        ddata[i] = 0xC0;
        i++;
        ddata[i] = chset2[charindx];
        i++;
        charindx++;
    }
    ddata[i] = 0x40;
    i++;
    ddata[i] = chset2[charindx];
    i++;
    charindx++;    
    
    while(i2c_Ready() != I2C_STATUS_IDLE);
   
    i2c_Write(ddata, i);
   
 }
 
 void display_Value(int16_t val){
     bool negf;
     uint8_t pos= 6;
     
     if(val < 0){
         negf = true;
         val = (~val + 1);
     }
     else{
         negf = false;
     }
     
     if(val == 0){
         sh1106_Char(1, 1, 0);
         sh1106_Char(2, 1, 0);
         sh1106_Char(3, 1, 0);
         sh1106_Char(4, 1, 0);
         sh1106_Char(5, 1, 0);
         sh1106_Char(6, 1, 10);         
         return;
     }     
   
     int dig;
     
     while(val != 0){
     
        dig = val % 10;
        if(dig == 0)
            dig = 10;
        sh1106_Char(pos, 1, dig);
         
        val = val / 10;
        pos--;           
         
     }         
     
     if(negf == true){
         sh1106_Char(pos, 1, 11);
         pos--;
     }
     
     for(; pos > 0 ; pos--){
         sh1106_Char(pos, 1, 0);
     }
          
 }
 
 void display_Line3(int16_t val){
     bool negf;
     uint8_t pos= 6;
     
     if(val < 0){
         negf = true;
         val = (~val + 1);
     }
     else{
         negf = false;
     }
     
     if(val == 0){
         sh1106_Char(1, 4, 0);
         sh1106_Char(2, 4, 0);
         sh1106_Char(3, 4, 0);
         sh1106_Char(4, 4, 0);
         sh1106_Char(5, 4, 0);
         sh1106_Char(6, 4, 10);         
         return;
     }     
   
     int dig;
     
     while(val != 0){
     
        dig = val % 10;
        if(dig == 0)
            dig = 10;
        sh1106_Char(pos, 4, dig);
         
        val = val / 10;
        pos--;
     }         
     
     if(negf == true){
         sh1106_Char(pos, 4, 11);
         pos--;
     }
     
     for(; pos > 0 ; pos--){
         sh1106_Char(pos, 4, 0);
     }
 }